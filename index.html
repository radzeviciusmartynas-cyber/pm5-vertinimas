<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Komandos nari≈≥ vertinimas</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { font-family: 'Raleway', sans-serif !important; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://wlgkkwmjpnpzhhownmjk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsZ2trd21qcG5wemhob3dubWprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjM1MjUsImV4cCI6MjA4NDM5OTUyNX0.opERunumCrVW8ex-RKDYrl53ONgX1UtfGPirfiaSVHk';
        const ADMIN_PASSWORD = 'destytojas2025';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const VOTING_START = new Date('2026-01-20T10:00:00');
        const VOTING_END = new Date('2026-01-20T14:00:00');

        const TEAMS_DATA = {
            "Lep≈°iai": ["Astijus Sta≈°inskis", "Justas Remeika", "Titas Zablockis", "Gabija Graba≈æi≈´tƒó", "Aistƒó ≈Ωiogaitƒó", "Mija Vilkaitƒó"],
            "Musmƒórƒós": ["Laura Bajarskaitƒó", "Viltƒó Buo≈æytƒó", "Urtƒó Jankytƒó", "Austƒója Mockaitytƒó", "Meda Paulauskaitƒó"],
            "Kazlƒókai": ["Lukas Pijus Anu≈æis", "Arentas Bubelis", "Auksƒó Janu≈°keviƒçi≈´tƒó", "Laurynas Navickas", "Gustas U≈ækuraitis", "Aironas Vy≈°niauskas"],
            "Baravykai": ["Martynas Nekra≈°as", "Martynas Simutis", "Deimantƒó Vidzickaitƒó", "Tomas Dirda", "Erikas Rimkus"],
            "Babausiai": ["Adrijus Krol", "Viltƒó Vetlovaitƒó", "Nojus Sp≈´dys", "Ernesta Jureviƒçi≈´tƒó", "Nedas Petkeviƒçius", "Vygantas Marƒçiulaitis"],
            "Gryb≈≥ karas": ["Vaiva Tulickaitƒó", "Austƒója ≈†alƒçi≈´tƒó", "Miglƒó Januleviƒçi≈´tƒó", "Matas Ananevas", "Jordanas Kmielius"],
            "Eringi": ["Melita Janaviƒçi≈´tƒó", "Aurƒója Jaruseviƒçi≈´tƒó", "Lukas Lapkovskis", "Vika Govoruchinaitƒó", "Estela Grigalaitytƒó"],
            "Nefunkciniai grybai": ["Skaistƒó Drumstaitƒó", "Vakarƒó Kastravickaitƒó", "Mila Milo≈°aitƒó", "Urtƒó Bei≈°inaitƒó", "Emilija Brindzaitƒó"],
            "Voveraitƒós": ["Ieva Janulytƒó", "Gustƒó Remeikaitƒó", "Diana Slavickaitƒó", "Emilija Sandargaitƒó", "Neda Saudargaitƒó"],
            "Gauruotieji mƒó≈°lagrybiai": ["Laurynas Stakƒó", "Marius Jonika", "Jovaras Mickeviƒçius", "Deivis Aleksynas", "Marius Griza"],
            "Pievagrybiai": ["Grƒóta Gaidamaviƒçi≈´tƒó", "Rugilƒó Margeviƒçi≈´tƒó", "Rugilƒó Babelytƒó", "Jurgita ≈†idlauskaitƒó", "Goda Varaneckaitƒó", "Augustas Maru≈°auskas"],
            "Kelmuƒçi≈≥ gribai": ["Urtƒó Aleksaitƒó", "Mer≈´nƒó Paƒçkauskaitƒó", "Medeina Makareviƒçi≈´tƒó", "Amelija ≈Ωukaitƒó", "Emilija Mankeviƒçi≈´tƒó", "Rugilƒó Balƒçi≈´tƒó"]
        };

        const TEAM_NAMES = Object.keys(TEAMS_DATA).sort();

        const CRITERIA = [
            { id: "apimtis", name: "Darbo apimtis", desc: "Kiek realiai prisidƒójo prie bendro rezultato?" },
            { id: "kokybe", name: "Darbo kokybƒó", desc: "Ar atliktas darbas buvo kokybi≈°kas?" },
            { id: "iniciatyvumas", name: "Iniciatyvumas", desc: "Ar si≈´lƒó idƒójas, vedƒó diskusijas?" },
            { id: "patikimumas", name: "Patikimumas", desc: "Ar laiku atliko savo dalƒØ, laikƒósi susitarim≈≥?" },
            { id: "bendradarbiavimas", name: "Bendradarbiavimas", desc: "Ar buvo atviras kit≈≥ idƒójoms, padƒójo kitiems?" }
        ];

        const LocalStatus = {
            hasCompletedEvaluation: function(evaluator) {
                try { 
                    const data = JSON.parse(localStorage.getItem('eval_status') || '{}');
                    return data[evaluator] === true;
                } catch(e) { return false; }
            },
            markEvaluationComplete: function(evaluator) {
                try {
                    const data = JSON.parse(localStorage.getItem('eval_status') || '{}');
                    data[evaluator] = true;
                    localStorage.setItem('eval_status', JSON.stringify(data));
                } catch(e) {}
            },
            hasVoted: function(voter) {
                try { 
                    const data = JSON.parse(localStorage.getItem('vote_status') || '{}');
                    return data[voter] || null;
                } catch(e) { return null; }
            },
            markVoted: function(voter, votedFor) {
                try {
                    const data = JSON.parse(localStorage.getItem('vote_status') || '{}');
                    data[voter] = votedFor;
                    localStorage.setItem('vote_status', JSON.stringify(data));
                } catch(e) {}
            },
            clearStudent: function(student) {
                try {
                    const evalData = JSON.parse(localStorage.getItem('eval_status') || '{}');
                    delete evalData[student];
                    localStorage.setItem('eval_status', JSON.stringify(evalData));
                } catch(e) {}
            }
        };

        function isVotingOpen() {
            const now = new Date();
            return now >= VOTING_START && now <= VOTING_END;
        }

        function getVotingStatus() {
            const now = new Date();
            if (now < VOTING_START) {
                return { status: 'before', message: 'Balsavimas prasidƒós ' + VOTING_START.toLocaleDateString('lt-LT') + ' ' + VOTING_START.toLocaleTimeString('lt-LT', {hour: '2-digit', minute: '2-digit'}) };
            } else if (now > VOTING_END) {
                return { status: 'after', message: 'Balsavimas baigƒósi' };
            } else {
                const remaining = Math.round((VOTING_END - now) / 1000 / 60);
                return { status: 'open', message: 'Balsavimas atviras! Liko ' + remaining + ' min.' };
            }
        }

        function App() {
            const [view, setView] = useState("start");
            const [selectedTeam, setSelectedTeam] = useState("");
            const [currentUser, setCurrentUser] = useState("");
            const [currentEvalIndex, setCurrentEvalIndex] = useState(0);
            const [currentRatings, setCurrentRatings] = useState({});
            const [currentComments, setCurrentComments] = useState({ darbai: "", indelis: "", tobulinti: "" });
            const [selectedVote, setSelectedVote] = useState("");
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [error, setError] = useState("");
            const [refreshKey, setRefreshKey] = useState(0);
            
            const [adminPassword, setAdminPassword] = useState("");
            const [adminError, setAdminError] = useState("");
            const [adminTab, setAdminTab] = useState("evaluations");
            const [allData, setAllData] = useState([]);
            const [allVotes, setAllVotes] = useState([]);
            const [selectedTeamFilter, setSelectedTeamFilter] = useState("all");
            const [isLoading, setIsLoading] = useState(false);
            const [deleteStudent, setDeleteStudent] = useState("");

            const teamMembers = selectedTeam ? TEAMS_DATA[selectedTeam].filter(function(m) { return m !== currentUser; }) : [];
            const votableTeams = TEAM_NAMES.filter(function(t) { return t !== selectedTeam; });

            useEffect(function() {
                const timer = setInterval(function() { setRefreshKey(function(k) { return k + 1; }); }, 60000);
                return function() { clearInterval(timer); };
            }, []);

            async function handleAdminLogin() {
                if (adminPassword === ADMIN_PASSWORD) {
                    setAdminError("");
                    setIsLoading(true);
                    await loadAdminData();
                    setIsLoading(false);
                    setView("admin");
                } else {
                    setAdminError("Neteisingas slapta≈æodis");
                }
            }

            async function loadAdminData() {
                try {
                    const { data: evalData, error: evalError } = await supabase.rpc('get_evaluations', { admin_password: ADMIN_PASSWORD });
                    if (evalError) throw evalError;
                    setAllData(evalData || []);

                    const { data: voteData, error: voteError } = await supabase.rpc('get_votes', { admin_password: ADMIN_PASSWORD });
                    if (voteError) throw voteError;
                    setAllVotes(voteData || []);
                } catch (err) {
                    console.error(err);
                    setAdminError("Klaida kraunant duomenis: " + err.message);
                }
            }

            async function handleDeleteStudent() {
                if (!deleteStudent) {
                    alert("Pasirinkite studentƒÖ");
                    return;
                }
                if (!confirm("Ar tikrai norite i≈°trinti " + deleteStudent + " vertinimus? Studentas galƒós pateikti i≈° naujo.")) {
                    return;
                }
                
                setIsLoading(true);
                try {
                    const { data, error } = await supabase.rpc('delete_student_evaluations', { 
                        admin_password: ADMIN_PASSWORD, 
                        student_name: deleteStudent 
                    });
                    if (error) throw error;
                    alert(data);
                    LocalStatus.clearStudent(deleteStudent);
                    await loadAdminData();
                    setDeleteStudent("");
                } catch (err) {
                    alert("Klaida: " + err.message);
                } finally {
                    setIsLoading(false);
                }
            }

            async function handleStartEvaluation() {
                if (selectedTeam && currentUser) {
                    if (LocalStatus.hasCompletedEvaluation(currentUser)) {
                        alert("J≈´s jau ƒØvertinote savo komandos narius. VertinimƒÖ galima pateikti tik vienƒÖ kartƒÖ.");
                        return;
                    }
                    setCurrentEvalIndex(0);
                    setCurrentRatings({});
                    setCurrentComments({ darbai: "", indelis: "", tobulinti: "" });
                    setError("");
                    setView("evaluate");
                }
            }

            function handleStartVoting() {
                if (!isVotingOpen()) return;
                if (selectedTeam && currentUser) {
                    const existingVote = LocalStatus.hasVoted(currentUser);
                    setSelectedVote(existingVote || "");
                    setError("");
                    setView("vote");
                }
            }

            async function handleSubmitCurrent() {
                const allRated = CRITERIA.every(function(c) { return currentRatings[c.id]; });
                if (!allRated) {
                    alert("Pra≈°ome ƒØvertinti visus kriterijus (1-10)");
                    return;
                }

                setIsSubmitting(true);
                setError("");

                try {
                    const { error: insertError } = await supabase
                        .from('evaluations')
                        .insert({
                            evaluator_team: selectedTeam,
                            evaluator: currentUser,
                            evaluated: teamMembers[currentEvalIndex],
                            rating_apimtis: currentRatings.apimtis,
                            rating_kokybe: currentRatings.kokybe,
                            rating_iniciatyvumas: currentRatings.iniciatyvumas,
                            rating_patikimumas: currentRatings.patikimumas,
                            rating_bendradarbiavimas: currentRatings.bendradarbiavimas,
                            comment_darbai: currentComments.darbai || null,
                            comment_indelis: currentComments.indelis || null,
                            comment_tobulinti: currentComments.tobulinti || null
                        });

                    if (insertError) {
                        if (insertError.code === '23505') {
                            setError("≈†ƒØ asmenƒØ jau vertinote anksƒçiau.");
                        } else {
                            throw insertError;
                        }
                    }

                    if (currentEvalIndex < teamMembers.length - 1) {
                        setCurrentEvalIndex(currentEvalIndex + 1);
                        setCurrentRatings({});
                        setCurrentComments({ darbai: "", indelis: "", tobulinti: "" });
                    } else {
                        LocalStatus.markEvaluationComplete(currentUser);
                        setView("done");
                    }
                } catch (err) {
                    console.error(err);
                    setError("Klaida saugant. Bandykite dar kartƒÖ.");
                } finally {
                    setIsSubmitting(false);
                }
            }

            async function handleSubmitVote() {
                if (!isVotingOpen()) {
                    alert("Balsavimo laikas pasibaigƒó arba dar neprasidƒójo.");
                    return;
                }
                if (!selectedVote) {
                    alert("Pasirinkite komandƒÖ");
                    return;
                }

                setIsSubmitting(true);
                setError("");

                try {
                    const existingVote = LocalStatus.hasVoted(currentUser);
                    
                    if (existingVote) {
                        const { error: updateError } = await supabase
                            .from('votes')
                            .update({ voted_for: selectedVote })
                            .eq('voter', currentUser);
                        if (updateError) throw updateError;
                    } else {
                        const { error: insertError } = await supabase
                            .from('votes')
                            .insert({
                                voter_team: selectedTeam,
                                voter: currentUser,
                                voted_for: selectedVote
                            });

                        if (insertError) {
                            if (insertError.code === '23505') {
                                const { error: updateError } = await supabase
                                    .from('votes')
                                    .update({ voted_for: selectedVote })
                                    .eq('voter', currentUser);
                                if (updateError) throw updateError;
                            } else {
                                throw insertError;
                            }
                        }
                    }

                    LocalStatus.markVoted(currentUser, selectedVote);
                    setView("voteDone");
                } catch (err) {
                    console.error(err);
                    setError("Klaida saugant balsƒÖ. Bandykite dar kartƒÖ.");
                } finally {
                    setIsSubmitting(false);
                }
            }

            function calculateStats() {
                const stats = {};
                Object.keys(TEAMS_DATA).forEach(function(team) {
                    TEAMS_DATA[team].forEach(function(student) {
                        stats[student] = { team: team, count: 0, ratings: {}, comments: [] };
                        CRITERIA.forEach(function(c) { stats[student].ratings[c.id] = []; });
                    });
                });
                allData.forEach(function(entry) {
                    if (stats[entry.evaluated]) {
                        stats[entry.evaluated].count++;
                        CRITERIA.forEach(function(c) {
                            const val = entry['rating_' + c.id];
                            if (val) stats[entry.evaluated].ratings[c.id].push(val);
                        });
                    }
                });
                return stats;
            }

            function calculateVoteStats() {
                const stats = {};
                TEAM_NAMES.forEach(function(team) { stats[team] = { votes: 0 }; });
                allVotes.forEach(function(vote) { if (stats[vote.voted_for]) stats[vote.voted_for].votes++; });
                return stats;
            }

            function avg(arr) {
                return arr.length ? (arr.reduce(function(a, b) { return a + b; }, 0) / arr.length).toFixed(1) : "-";
            }

            function getCompletionStats() {
                const stats = {};
                Object.keys(TEAMS_DATA).forEach(function(team) {
                    const members = TEAMS_DATA[team];
                    const total = members.length * (members.length - 1);
                    let completed = 0;
                    members.forEach(function(member) {
                        completed += allData.filter(function(e) { return e.evaluator === member && e.evaluator_team === team; }).length;
                    });
                    stats[team] = { completed: completed, total: total, percent: total > 0 ? Math.round(completed / total * 100) : 0 };
                });
                return stats;
            }

            function exportCSV() {
                const stats = calculateStats();
                let csv = "Komanda,Studentas,Vertinimu sk.,Darbo apimtis,Darbo kokybe,Iniciatyvumas,Patikimumas,Bendradarbiavimas,Bendras vidurkis\n";
                Object.entries(stats).forEach(function([student, data]) {
                    const avgs = CRITERIA.map(function(c) { return avg(data.ratings[c.id]); });
                    const numericAvgs = avgs.filter(function(a) { return a !== "-"; }).map(Number);
                    const overall = numericAvgs.length ? (numericAvgs.reduce(function(a, b) { return a + b; }, 0) / numericAvgs.length).toFixed(1) : "-";
                    csv += '"' + data.team + '","' + student + '",' + data.count + ',' + avgs.join(",") + ',' + overall + "\n";
                });
                const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "vertinimo_rezultatai.csv";
                a.click();
            }

            function exportVotesCSV() {
                const stats = calculateVoteStats();
                let csv = "Komanda,Balsu skaicius,Procentas\n";
                Object.entries(stats).sort(function(a, b) { return b[1].votes - a[1].votes; }).forEach(function([team, data]) {
                    const percent = allVotes.length > 0 ? ((data.votes / allVotes.length) * 100).toFixed(1) : "0";
                    csv += '"' + team + '",' + data.votes + ',' + percent + "%\n";
                });
                const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "balsavimo_rezultatai.csv";
                a.click();
            }

            if (view === "start") {
                const hasVoted = currentUser && LocalStatus.hasVoted(currentUser);
                const existingVote = hasVoted;
                const hasCompletedEval = currentUser && LocalStatus.hasCompletedEvaluation(currentUser);
                const votingStatus = getVotingStatus();
                const votingOpen = isVotingOpen();

                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-4">
                        <div className="max-w-lg mx-auto">
                            <div className="bg-white rounded-2xl shadow-xl p-8 mt-8">
                                <div className="text-center mb-6">
                                    <span className="text-5xl">üçÑ</span>
                                    <h1 className="text-2xl font-bold text-gray-800 mt-3">Komandos vertinimas</h1>
                                    <p className="text-gray-500 mt-1">Pasirinkite veiksmƒÖ</p>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">J≈´s≈≥ komanda</label>
                                        <select value={selectedTeam} onChange={function(e) { setSelectedTeam(e.target.value); setCurrentUser(""); }} className="w-full p-3 border-2 border-gray-200 rounded-xl">
                                            <option value="">‚Äî Pasirinkite komandƒÖ ‚Äî</option>
                                            {TEAM_NAMES.map(function(team) { return <option key={team} value={team}>{team}</option>; })}
                                        </select>
                                    </div>
                                    {selectedTeam && (
                                        <div>
                                            <label className="block text-sm font-semibold text-gray-700 mb-2">J≈´s esate</label>
                                            <select value={currentUser} onChange={function(e) { setCurrentUser(e.target.value); }} className="w-full p-3 border-2 border-gray-200 rounded-xl">
                                                <option value="">‚Äî Pasirinkite save ‚Äî</option>
                                                {TEAMS_DATA[selectedTeam].map(function(m) { return <option key={m} value={m}>{m}</option>; })}
                                            </select>
                                        </div>
                                    )}
                                    {currentUser && (
                                        <div className="space-y-3 pt-2">
                                            {hasCompletedEval ? (
                                                <div className="w-full py-4 bg-green-100 text-green-700 font-semibold rounded-xl flex items-center justify-center gap-3 border-2 border-green-300">
                                                    <span>‚úÖ</span> Komandos vertinimas pateiktas
                                                </div>
                                            ) : (
                                                <button onClick={handleStartEvaluation} className="w-full py-4 bg-amber-600 text-white font-semibold rounded-xl hover:bg-amber-700 flex items-center justify-center gap-3">
                                                    <span>üë•</span> Vertinti komandos narius
                                                </button>
                                            )}
                                            {votingOpen ? (
                                                <React.Fragment>
                                                    <button onClick={handleStartVoting} className={"w-full py-4 font-semibold rounded-xl flex items-center justify-center gap-3 " + (hasVoted ? "bg-green-100 text-green-700 border-2 border-green-300" : "bg-purple-600 text-white hover:bg-purple-700")}>
                                                        <span>üèÜ</span> {hasVoted ? "Pakeisti balsƒÖ" : "Balsuoti u≈æ geriausiƒÖ pristatymƒÖ"}
                                                    </button>
                                                    <p className="text-center text-sm text-purple-600 font-medium">‚è±Ô∏è {votingStatus.message}</p>
                                                    {hasVoted && (
                                                        <p className="text-center text-sm text-green-600">‚úì Balsavote u≈æ: <strong>{existingVote}</strong></p>
                                                    )}
                                                </React.Fragment>
                                            ) : (
                                                <div className="w-full py-4 bg-gray-100 text-gray-500 font-semibold rounded-xl flex flex-col items-center justify-center gap-1">
                                                    <div className="flex items-center gap-2">
                                                        <span>üèÜ</span> Balsavimas u≈æ geriausiƒÖ pristatymƒÖ
                                                    </div>
                                                    <span className="text-xs font-normal">üîí {votingStatus.message}</span>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="mt-8 pt-6 border-t">
                                    <p className="text-xs text-gray-400 text-center mb-3">Dƒóstytojams</p>
                                    <div className="flex gap-2">
                                        <input type="password" placeholder="Slapta≈æodis" value={adminPassword} onChange={function(e) { setAdminPassword(e.target.value); }} onKeyDown={function(e) { if (e.key === 'Enter') handleAdminLogin(); }} className="flex-1 p-2 text-sm border rounded-lg" />
                                        <button onClick={handleAdminLogin} disabled={isLoading} className="px-4 py-2 text-sm bg-gray-100 rounded-lg hover:bg-gray-200">
                                            {isLoading ? "..." : "Rezultatai"}
                                        </button>
                                    </div>
                                    {adminError && <p className="text-red-500 text-xs mt-2 text-center">{adminError}</p>}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === "vote") {
                const votingStatus = getVotingStatus();
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 p-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-white rounded-2xl shadow-xl p-6 mt-4">
                                <div className="text-center mb-6">
                                    <span className="text-4xl">üèÜ</span>
                                    <h2 className="text-xl font-bold text-gray-800 mt-2">Geriausio pristatymo rinkimai</h2>
                                    <p className="text-gray-500">Pasirinkite geriausiai pristaƒçiusiƒÖ komandƒÖ</p>
                                    <p className="text-purple-600 text-sm mt-2 font-medium">{currentUser} ({selectedTeam})</p>
                                    <p className="text-purple-500 text-xs mt-1">‚è±Ô∏è {votingStatus.message}</p>
                                </div>
                                {error && <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{error}</div>}
                                <div className="space-y-2 mb-6">
                                    {votableTeams.map(function(team) {
                                        return (
                                            <button key={team} onClick={function() { setSelectedVote(team); }} disabled={isSubmitting} className={"w-full p-4 rounded-xl border-2 text-left flex items-center gap-4 " + (selectedVote === team ? "border-purple-500 bg-purple-50" : "border-gray-200 hover:border-purple-300")}>
                                                <div className={"w-5 h-5 rounded-full border-2 flex items-center justify-center " + (selectedVote === team ? "border-purple-500 bg-purple-500" : "border-gray-300")}>
                                                    {selectedVote === team && <span className="text-white text-xs">‚úì</span>}
                                                </div>
                                                <span className="font-semibold">{team}</span>
                                            </button>
                                        );
                                    })}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={function() { setView("start"); }} disabled={isSubmitting} className="flex-1 py-3 bg-gray-100 rounded-xl hover:bg-gray-200">‚Üê Atgal</button>
                                    <button onClick={handleSubmitVote} disabled={!selectedVote || isSubmitting} className="flex-1 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 disabled:bg-gray-300">
                                        {isSubmitting ? "Saugoma..." : "Balsuoti ‚úì"}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === "voteDone") {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md">
                            <div className="text-6xl mb-4">üéâ</div>
                            <h1 className="text-2xl font-bold mb-2">Aƒçi≈´ u≈æ balsƒÖ!</h1>
                            <p className="text-gray-600 mb-2">J≈´s balsavote u≈æ:</p>
                            <p className="text-xl font-bold text-purple-600 mb-6">{selectedVote}</p>
                            <button onClick={function() { setView("start"); setSelectedVote(""); }} className="px-6 py-3 bg-gray-100 rounded-xl hover:bg-gray-200">GrƒØ≈æti ƒØ prad≈æiƒÖ</button>
                        </div>
                    </div>
                );
            }

            if (view === "evaluate") {
                const currentMember = teamMembers[currentEvalIndex];
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 p-4">
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-white rounded-2xl shadow-xl p-6 mt-4">
                                <div className="flex justify-between items-center mb-6">
                                    <div>
                                        <p className="text-sm text-amber-600 font-semibold">üçÑ {selectedTeam}</p>
                                        <h2 className="text-xl font-bold">Vertinate: {currentMember}</h2>
                                    </div>
                                    <div className="text-2xl font-bold text-amber-600">{currentEvalIndex + 1}/{teamMembers.length}</div>
                                </div>
                                {error && <div className="mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm">{error}</div>}
                                <div className="space-y-4 mb-6">
                                    {CRITERIA.map(function(c) {
                                        return (
                                            <div key={c.id} className="bg-gray-50 rounded-xl p-4">
                                                <div className="flex justify-between mb-2">
                                                    <div>
                                                        <h3 className="font-semibold">{c.name}</h3>
                                                        <p className="text-xs text-gray-500">{c.desc}</p>
                                                    </div>
                                                    <div className="text-2xl font-bold text-amber-600 w-10 text-center">{currentRatings[c.id] || "‚Äî"}</div>
                                                </div>
                                                <div className="flex gap-1">
                                                    {[1,2,3,4,5,6,7,8,9,10].map(function(n) {
                                                        return <button key={n} onClick={function() { setCurrentRatings(Object.assign({}, currentRatings, {[c.id]: n})); }} disabled={isSubmitting} className={"flex-1 py-2 text-sm font-semibold rounded-lg " + (currentRatings[c.id] === n ? "bg-amber-600 text-white" : "bg-white border border-gray-200 hover:bg-amber-50")}>{n}</button>;
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                <div className="space-y-3 mb-6">
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Atlikti darbai <span className="text-gray-400 font-normal">(neprivaloma)</span></label>
                                        <textarea value={currentComments.darbai} onChange={function(e) { setCurrentComments(Object.assign({}, currentComments, {darbai: e.target.value})); }} disabled={isSubmitting} className="w-full p-3 border rounded-xl text-sm" rows={2} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">Did≈æiausias indƒólis <span className="text-gray-400 font-normal">(neprivaloma)</span></label>
                                        <textarea value={currentComments.indelis} onChange={function(e) { setCurrentComments(Object.assign({}, currentComments, {indelis: e.target.value})); }} disabled={isSubmitting} className="w-full p-3 border rounded-xl text-sm" rows={2} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold mb-1">KƒÖ tobulinti? <span className="text-gray-400 font-normal">(neprivaloma)</span></label>
                                        <textarea value={currentComments.tobulinti} onChange={function(e) { setCurrentComments(Object.assign({}, currentComments, {tobulinti: e.target.value})); }} disabled={isSubmitting} className="w-full p-3 border rounded-xl text-sm" rows={2} />
                                    </div>
                                </div>
                                <button onClick={handleSubmitCurrent} disabled={isSubmitting} className="w-full py-4 bg-amber-600 text-white font-semibold rounded-xl hover:bg-amber-700 disabled:bg-gray-400">
                                    {isSubmitting ? "Saugoma..." : (currentEvalIndex < teamMembers.length - 1 ? "I≈°saugoti ir tƒôsti ‚Üí" : "Baigti vertinimƒÖ ‚úì")}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === "done") {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md">
                            <div className="text-6xl mb-4">‚úÖ</div>
                            <h1 className="text-2xl font-bold mb-2">Aƒçi≈´, {currentUser.split(' ')[0]}!</h1>
                            <p className="text-gray-600 mb-6">Vertinimai saugiai i≈°saugoti.</p>
                            <button onClick={function() { setView("start"); setSelectedTeam(""); setCurrentUser(""); }} className="px-6 py-3 bg-gray-100 rounded-xl hover:bg-gray-200">GrƒØ≈æti ƒØ prad≈æiƒÖ</button>
                        </div>
                    </div>
                );
            }

            if (view === "admin") {
                const stats = calculateStats();
                const voteStats = calculateVoteStats();
                const completionStats = getCompletionStats();
                const filteredStudents = Object.entries(stats).filter(function([_, d]) { return selectedTeamFilter === "all" || d.team === selectedTeamFilter; }).sort(function(a, b) { return a[1].team.localeCompare(b[1].team); });
                const totalCompleted = Object.values(completionStats).reduce(function(s, x) { return s + x.completed; }, 0);
                const totalExpected = Object.values(completionStats).reduce(function(s, x) { return s + x.total; }, 0);
                const sortedVotes = Object.entries(voteStats).sort(function(a, b) { return b[1].votes - a[1].votes; });
                const maxVotes = sortedVotes[0] ? sortedVotes[0][1].votes : 0;
                const votingStatus = getVotingStatus();
                
                const allStudents = [];
                Object.keys(TEAMS_DATA).forEach(function(team) {
                    TEAMS_DATA[team].forEach(function(s) { allStudents.push(s); });
                });
                allStudents.sort();

                return (
                    <div className="min-h-screen bg-gray-100 p-4">
                        <div className="max-w-6xl mx-auto">
                            <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                                <div className="flex justify-between items-center flex-wrap gap-4">
                                    <h1 className="text-xl font-bold">üçÑ Rezultatai</h1>
                                    <div className="flex gap-2">
                                        <button onClick={async function() { setIsLoading(true); await loadAdminData(); setIsLoading(false); }} disabled={isLoading} className="px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm">
                                            {isLoading ? "..." : "üîÑ Atnaujinti"}
                                        </button>
                                        <button onClick={function() { setView("start"); setAdminPassword(""); }} className="px-3 py-1.5 bg-gray-100 rounded-lg text-sm">‚Üê GrƒØ≈æti</button>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={function() { setAdminTab("evaluations"); }} className={"px-4 py-2 rounded-lg font-medium " + (adminTab === "evaluations" ? "bg-amber-600 text-white" : "bg-gray-100")}>üë• Vertinimai</button>
                                    <button onClick={function() { setAdminTab("votes"); }} className={"px-4 py-2 rounded-lg font-medium " + (adminTab === "votes" ? "bg-purple-600 text-white" : "bg-gray-100")}>üèÜ Balsavimas</button>
                                    <button onClick={function() { setAdminTab("manage"); }} className={"px-4 py-2 rounded-lg font-medium " + (adminTab === "manage" ? "bg-red-600 text-white" : "bg-gray-100")}>‚öôÔ∏è Valdymas</button>
                                </div>
                            </div>

                            {adminTab === "evaluations" && (
                                <React.Fragment>
                                    <div className="bg-white rounded-xl shadow-lg p-4 mb-4">
                                        <div className="flex justify-between items-center mb-4 flex-wrap gap-2">
                                            <p>U≈æpildyta: <strong>{totalCompleted}</strong> / {totalExpected} ({totalExpected > 0 ? Math.round(totalCompleted/totalExpected*100) : 0}%)</p>
                                            <div className="flex gap-2">
                                                <select value={selectedTeamFilter} onChange={function(e) { setSelectedTeamFilter(e.target.value); }} className="px-3 py-1.5 border rounded-lg text-sm">
                                                    <option value="all">Visos komandos</option>
                                                    {TEAM_NAMES.map(function(t) { return <option key={t} value={t}>{t}</option>; })}
                                                </select>
                                                <button onClick={exportCSV} className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm">üì• CSV</button>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                                            {Object.entries(completionStats).sort(function(a,b) { return a[0].localeCompare(b[0]); }).map(function([team, d]) {
                                                return (
                                                    <div key={team} className="bg-gray-50 rounded-lg p-2">
                                                        <div className="text-xs font-semibold truncate">{team}</div>
                                                        <div className="flex items-center gap-1 mt-1">
                                                            <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                <div className={"h-full " + (d.percent === 100 ? 'bg-green-500' : d.percent > 50 ? 'bg-amber-500' : 'bg-red-400')} style={{width: d.percent + "%"}} />
                                                            </div>
                                                            <span className="text-xs font-bold w-8 text-right">{d.percent}%</span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-800 text-white">
                                                    <tr>
                                                        <th className="px-3 py-2 text-left">Komanda</th>
                                                        <th className="px-3 py-2 text-left">Studentas</th>
                                                        <th className="px-3 py-2 text-center">N</th>
                                                        {CRITERIA.map(function(c) { return <th key={c.id} className="px-2 py-2 text-center">{c.name.split(' ')[0]}</th>; })}
                                                        <th className="px-3 py-2 text-center bg-gray-700">Vidurkis</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {filteredStudents.map(function([student, data], idx) {
                                                        const avgs = CRITERIA.map(function(c) { return avg(data.ratings[c.id]); });
                                                        const numericAvgs = avgs.filter(function(a) { return a !== "-"; }).map(Number);
                                                        const overall = numericAvgs.length ? (numericAvgs.reduce(function(a, b) { return a + b; }, 0) / numericAvgs.length).toFixed(1) : "-";
                                                        return (
                                                            <tr key={student} className={idx % 2 ? "bg-gray-50" : ""}>
                                                                <td className="px-3 py-2 text-xs text-gray-500">{data.team}</td>
                                                                <td className="px-3 py-2 font-medium">{student}</td>
                                                                <td className="px-3 py-2 text-center"><span className={"px-2 py-0.5 rounded text-xs " + (data.count === 0 ? 'bg-red-100 text-red-700' : 'bg-gray-100')}>{data.count}</span></td>
                                                                {avgs.map(function(a, i) { return <td key={i} className={"px-2 py-2 text-center " + (a !== "-" && Number(a) < 6 ? "text-red-600 font-semibold" : "")}>{a}</td>; })}
                                                                <td className={"px-3 py-2 text-center font-bold " + (overall !== "-" && Number(overall) < 6 ? "bg-red-100 text-red-700" : overall !== "-" && Number(overall) >= 8 ? "bg-green-100 text-green-700" : "bg-amber-50 text-amber-700")}>{overall}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </React.Fragment>
                            )}

                            {adminTab === "votes" && (
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <div className="flex justify-between items-start mb-4 flex-wrap gap-2">
                                        <div>
                                            <h2 className="text-xl font-bold">üèÜ Geriausio pristatymo rinkimai</h2>
                                            <p className="text-gray-500">I≈° viso bals≈≥: <strong>{allVotes.length}</strong></p>
                                        </div>
                                        <div className="flex gap-2">
                                            <div className={"px-3 py-1.5 rounded-lg text-sm font-medium " + (votingStatus.status === 'open' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600')}>
                                                {votingStatus.status === 'open' ? 'üü¢ ' : 'üîí '}{votingStatus.message}
                                            </div>
                                            <button onClick={exportVotesCSV} className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm">üì• CSV</button>
                                        </div>
                                    </div>
                                    {allVotes.length === 0 ? (
                                        <div className="text-center py-12 text-gray-400">
                                            <span className="text-4xl">üó≥Ô∏è</span>
                                            <p className="mt-2">Kol kas bals≈≥ nƒóra</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {sortedVotes.map(function([team, data], idx) {
                                                const percent = allVotes.length > 0 ? (data.votes / allVotes.length) * 100 : 0;
                                                const isWinner = idx === 0 && data.votes > 0;
                                                return (
                                                    <div key={team} className={"p-4 rounded-xl border-2 " + (isWinner ? 'border-yellow-400 bg-yellow-50' : 'border-gray-100 bg-gray-50')}>
                                                        <div className="flex justify-between items-center mb-2">
                                                            <div className="flex items-center gap-3">
                                                                {idx === 0 && data.votes > 0 && <span className="text-2xl">ü•á</span>}
                                                                {idx === 1 && data.votes > 0 && <span className="text-2xl">ü•à</span>}
                                                                {idx === 2 && data.votes > 0 && <span className="text-2xl">ü•â</span>}
                                                                <span className="font-bold text-lg">{team}</span>
                                                            </div>
                                                            <div>
                                                                <span className="text-2xl font-bold text-purple-600">{data.votes}</span>
                                                                <span className="text-gray-400 ml-1">({percent.toFixed(1)}%)</span>
                                                            </div>
                                                        </div>
                                                        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                                                            <div className={"h-full " + (isWinner ? 'bg-yellow-500' : 'bg-purple-500')} style={{width: (maxVotes > 0 ? (data.votes / maxVotes) * 100 : 0) + "%"}} />
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            )}

                            {adminTab === "manage" && (
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4">‚öôÔ∏è Valdymas</h2>
                                    
                                    <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                                        <h3 className="font-semibold text-amber-800 mb-2">üóëÔ∏è I≈°trinti studento vertinimus</h3>
                                        <p className="text-sm text-amber-700 mb-3">Studentas galƒós pateikti vertinimus i≈° naujo. Jis taip pat turƒós i≈°valyti nar≈°yklƒós cache (Ctrl+Shift+Delete) arba naudoti Incognito re≈æimƒÖ.</p>
                                        <div className="flex gap-2">
                                            <select value={deleteStudent} onChange={function(e) { setDeleteStudent(e.target.value); }} className="flex-1 p-2 border rounded-lg">
                                                <option value="">‚Äî Pasirinkite studentƒÖ ‚Äî</option>
                                                {allStudents.map(function(s) { return <option key={s} value={s}>{s}</option>; })}
                                            </select>
                                            <button onClick={handleDeleteStudent} disabled={isLoading || !deleteStudent} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300">
                                                {isLoading ? "..." : "I≈°trinti"}
                                            </button>
                                        </div>
                                    </div>

                                    <div className="bg-gray-50 border border-gray-200 rounded-xl p-4">
                                        <h3 className="font-semibold text-gray-800 mb-2">‚ÑπÔ∏è Informacija</h3>
                                        <ul className="text-sm text-gray-600 space-y-1">
                                            <li>‚Ä¢ Vertinim≈≥ ƒØra≈°≈≥: <strong>{allData.length}</strong></li>
                                            <li>‚Ä¢ Bals≈≥ ƒØra≈°≈≥: <strong>{allVotes.length}</strong></li>
                                            <li>‚Ä¢ Duomenys saugomi Supabase serveryje</li>
                                            <li>‚Ä¢ Studentai negali matyti kit≈≥ vertinim≈≥</li>
                                        </ul>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
